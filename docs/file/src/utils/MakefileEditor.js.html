<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/utils/MakefileEditor.js | tomo-cli</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A friendly command line tool designed to help create sustainable software using web technology"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="tomo-cli"><meta property="twitter:description" content="A friendly command line tool designed to help create sustainable software using web technology"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/jhwohlgemuth/tomo-cli"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui.js~UI.html">UI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-CommandError">CommandError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-OfflineWarning">OfflineWarning</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Task">Task</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-TaskList">TaskList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Warning">Warning</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-populateQueue">populateQueue</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#commands">commands</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-addA11y">addA11y</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-addBabel">addBabel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-addEsdoc">addEsdoc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-addJest">addJest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-addMakefile">addMakefile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-addPostcss">addPostcss</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-rustTasks">rustTasks</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-addWebpack">addWebpack</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-task">task</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#commands-add-eslint">commands/add-eslint</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tasks">tasks</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#commands-add-marionette">commands/add-marionette</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tasks">tasks</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/BasicEditor.js~BasicEditor.html">BasicEditor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/MakefileEditor.js~MakefileEditor.html">MakefileEditor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/Scaffolder.js~Scaffolder.html">Scaffolder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-allDoExist">allDoExist</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-allDoExistSync">allDoExistSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-allDoNotExist">allDoNotExist</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-allDoNotExistSync">allDoNotExistSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-format">format</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getBinDirectory">getBinDirectory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getCommandDirectory">getCommandDirectory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parse">parse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-someDoExist">someDoExist</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-someDoExistSync">someDoExistSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createJsonEditor">createJsonEditor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createModuleEditor">createModuleEditor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getIntendedInput">getIntendedInput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getVersions">getVersions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-install">install</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-verifyRustInstallation">verifyRustInstallation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BabelConfigModuleEditor">BabelConfigModuleEditor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-EslintConfigModuleEditor">EslintConfigModuleEditor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PackageJsonEditor">PackageJsonEditor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PostcssConfigEditor">PostcssConfigEditor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-WebpackConfigEditor">WebpackConfigEditor</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/utils/MakefileEditor.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {flow, kebabCase, last, negate} from &apos;lodash&apos;;
import {existsSync} from &apos;fs-extra&apos;;
import createJsonEditor from &apos;./createJsonEditor&apos;;
import createModuleEditor from &apos;./createModuleEditor&apos;;
import {getBinDirectory, parse} from &apos;./common&apos;;

const {assign, entries} = Object;
const {isArray} = Array;
const isNotArray = negate(isArray);
const silent = () =&gt; {};
const isLocalNpmCommand = (command, path = process.cwd()) =&gt; {
    const [packageDirectory] = path.split(&apos;Makefile&apos;);
    const Editor = createJsonEditor(&apos;package.json&apos;);
    const pkg = new Editor(packageDirectory);
    const pkgHasCommmand = pkg.hasAll(command);
    const binHasCommand = existsSync(`${getBinDirectory(path)}${command}`);
    return pkgHasCommmand || binHasCommand;
};
/**
 * Create and edit Makefiles. Includes ability to import package.json scripts.
 */
export class MakefileEditor extends createModuleEditor(&apos;Makefile&apos;) {
    contents = &apos;&apos;;
    scripts = {};
    useBinVariable = false;
    constructor(path = process.cwd()) {
        super(path);
    }
    write(contents) {
        const self = this;
        const {fs, path, queue} = self;
        queue
            .add(() =&gt; fs.write(path, contents))
            .then(() =&gt; self.created = existsSync(path))
            .catch(silent);
        return assign(self, {contents});
    }
    /**
     * Append line(s) to end of Makefile
     * @param {(string|Symbol)} [lines=Symbol(&apos;skip&apos;)] Lines to append
     * @return {MakefileEditor} Chaining OK
     */
    append(lines = Symbol(&apos;skip&apos;)) {
        const {contents} = this;
        const shouldSkip = (typeof lines === &apos;symbol&apos;);
        return shouldSkip ? this : this.write(`${contents}\n${lines}`);
    }
    /**
     * Prepend line(s) to top of Makefile (similar API to {@link MakefileEditor#append})
     * @param {(string|Symbol)} [lines=Symbol(&apos;skip&apos;)] Lines to append
     * @return {MakefileEditor} Chaining OK
     */
    prepend(lines = Symbol(&apos;skip&apos;)) {
        const {contents} = this;
        const shouldSkip = (typeof lines === &apos;symbol&apos;);
        return shouldSkip ? this : this.write(`${lines}\n${contents}`);
    }
    /**
     * Format task and remove package.json dependency by replacing npm with make and such
     * @param {string} action Task action
     * @param {object} scripts Scripts object imported from package.json (must run {@link MakefileEditor#importScripts} first)
     * @return {string} Formatted action
     */
    formatTask(action, scripts = {}) {
        const {path} = this;
        const formatTaskName = val =&gt; kebabCase(last(val.split(&apos; &apos;)));
        const replaceNpmRunQuotes = initial =&gt; {
            const re = /[&apos;&quot;]npm run .[^&quot;]*[&apos;&quot;]/g;
            const matches = action.match(re);
            return isNotArray(matches) ? initial : matches.reduce((acc, match) =&gt; acc.replace(match, `&apos;make ${formatTaskName(match)}&apos;`), initial);
        };
        const replaceNpmWithArguments = initial =&gt; {
            const re = /npm .* -- --.*/g;
            const matches = action.match(re);
            return isNotArray(matches) ? initial : matches.reduce((acc, match) =&gt; {
                const [commands, options] = match.split(&apos; -- &apos;);
                const task = last(commands.split(&apos; &apos;));
                return acc.replace(match, `${scripts[task]} ${options}`);
            }, initial);
        };
        const replaceNpmRunCommands = initial =&gt; {
            const re = /^npm run .*/g;
            const matches = action.match(re);
            return isNotArray(matches) ? initial : matches.reduce((acc, match) =&gt; acc.replace(match, `$(MAKE) ${formatTaskName(match)}`), initial);
        };
        const formatted = flow(
            replaceNpmRunQuotes,
            replaceNpmWithArguments,
            replaceNpmRunCommands
        )(action);
        const [command] = formatted.split(&apos; &apos;);
        const useBinVariable = isLocalNpmCommand(command, path);
        this.useBinVariable = this.useBinVariable || useBinVariable;
        return `${useBinVariable ? `$(bin)` : &apos;&apos;}${formatted}`;
    }
    /**
     * Add task to Makefile (appended to end)
     * @param {string} name Task name (&quot;build&quot;, &quot;lint&quot;, etc...)
     * @param {string[]} tasks Lines of code to be executed during task
     * @param {object} options Configure task
     * @param {string} [options.description] Task description used in help task
     * @param {boolean} [options.silent=false] Prepend &quot;@&quot; (true) or not (false)
     * @return {MakefileEditor} Chaining OK
     */
    addTask(name, tasks, options = {description: &apos;Task description&apos;}) {
        const self = this;
        const {scripts} = self;
        const {description} = options;
        return tasks.reduce((tasks, action) =&gt; tasks
            .append(`\t${self.formatTask(action, scripts)}`)
            .addTaskDescription(name, description)
        , self.append(`${name}:`));
    }
    /**
     * Add deescription to task for use during help task
     * @param {string} task Task name
     * @param {string} description Description text
     * @example
     * const makefile = await (new MakefileEditor())
     *     .addTask(&apos;foo&apos;, &apos;echo foo&apos;)
     *     .commit();
     * // foo: ## Task description &lt;-- default task description
     * //     echo foo
     * //
     * await makefile
     *     .addTaskDescription(&apos;foo&apos;, &apos;This task does foo&apos;)
     *     .commit();
     * // foo: ## This task does foo
     * //     echo foo
     * //
     * @return {MakefileEditor} Chaining OK
     */
    addTaskDescription(task, description = &apos;Task description&apos;) {
        const contents = this.contents.replace(`${kebabCase(task)}:\n`, `${kebabCase(task)}: ## ${description}\n`);
        return this.write(contents);
    }
    appendHelpTask() {
        const task = `@fgrep -h &quot;##&quot; $(MAKEFILE_LIST) | fgrep -v fgrep | sed -e &apos;s/\\$$//&apos; | sed -e &apos;s/##/\\n    /&apos;`;
        return this.addTask(&apos;help&apos;, [task], {description: &apos;Show this help&apos;});
    }
    /**
     * Add Makefile comment
     * @param {string} text Comment text
     * @return {MakefileEditor} Chaining OK
     */
    addComment(text) {
        return this.append(`# ${text}`);
    }
    importScripts() {
        const {path} = this;
        const [packageDirectory] = path.split(&apos;Makefile&apos;);
        const Editor = createJsonEditor(&apos;package.json&apos;);
        const pkg = (new Editor(packageDirectory)).read();
        const {scripts} = parse(pkg);
        return assign(this, {scripts});
    }
    /**
     * Append tasks imported from package.json
     * @example &lt;caption&gt;Must execute importScripts first&lt;/caption&gt;
     * const makefile = await (new MakefileEditor())
     *     .importScripts()
     *     .appendScripts()
     *     .commit();
     * @return {MakefileEditor} Chaining OK
     */
    appendScripts() {
        const self = this;
        const {path, scripts} = self;
        const tasks = entries(scripts).map(([key, value]) =&gt; [kebabCase(key), [value]]);
        const getPreTask = (tasks, name) =&gt; {
            const [data] = tasks
                .filter(([name]) =&gt; name.startsWith(&apos;pre&apos;))
                .map(([name, values]) =&gt; [name.substring(&apos;pre&apos;.length), values])
                .filter(task =&gt; task[0] === name);
            return isArray(data) ? data[1] : [];
        };
        const getPostTask = (tasks, name) =&gt; {
            const [data] = tasks
                .filter(([name]) =&gt; name.startsWith(&apos;post&apos;))
                .map(([name, values]) =&gt; [name.substring(&apos;post&apos;.length), values])
                .filter(task =&gt; task[0] === name);
            return isArray(data) ? data[1] : [];
        };
        return tasks
            .filter(([name]) =&gt; !(name.startsWith(&apos;pre&apos;) || name.startsWith(&apos;post&apos;)))
            .map(([name, values]) =&gt; [name, [...getPreTask(tasks, name), ...values, ...getPostTask(tasks, name)]])
            .reduce((tasks, [key, values]) =&gt; tasks.addTask(key, values).append(&apos;&apos;), self.append(&apos;&apos;))
            .prepend(self.useBinVariable ? `bin := ${getBinDirectory(path)}` : Symbol(&apos;skip&apos;))
            .prepend(`# Built from ${path}/package.json`);
    }
}
export default MakefileEditor;</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
