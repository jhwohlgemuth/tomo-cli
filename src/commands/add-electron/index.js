import {join} from 'path';
import {PackageJsonEditor, Scaffolder, allDoExist, install} from '../../api';

const DEPENDENCIES = [
    'electron',
    'electron-context-menu',
    'electron-debug',
    'electron-is-dev'
];
const DEV_DEPENDENCIES = [
    'electron-reloader',
    'npm-run-all',
    'spectron'
];
const ALWAYS = () => true;
/**
 * @type {task[]}
 * @see https://electronjs.org/
 */
export const tasks = [
    {
        text: 'Copy electron application files',
        task: async ({overwrite}) => {
            await (new Scaffolder(join(__dirname, 'templates')))
                .overwrite(overwrite)
                .target('.')
                .copy('index.js')
                .target('bin')
                .copy('preload.js')
                .commit();
        },
        condition: ALWAYS
    },
    {
        text: 'Configure metadata and add tasks to package.json',
        task: async ({useParcel}) => {
            const description = `Native Desktop application built with Electron`;
            const main = 'index.js';
            const name = 'tomo-native-app';
            const scripts = {
                'build:electron': 'npm-run-all build:es build:css',
                'prestart:electron': 'npm run build:electron',
                'start:electron': 'electron index --enable-logging',
                dev: `npm-run-all --parallel watch:es${useParcel ? '' : ' watch:css'} start:electron`
            };
            await (new PackageJsonEditor())
                .extend({description, main, name, scripts})
                .commit();
        },
        condition: () => allDoExist('package.json')
    },
    {
        text: 'Install electron dependencies',
        task: async ({skipInstall}) => {
            await install(DEPENDENCIES, {skipInstall});
            await install(DEV_DEPENDENCIES, {dev: true, skipInstall});
        },
        condition: ({isNotOffline, skipInstall}) => !skipInstall && isNotOffline && allDoExist('package.json')
    }
];
export default tasks;